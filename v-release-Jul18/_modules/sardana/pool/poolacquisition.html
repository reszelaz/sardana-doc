

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>sardana.pool.poolacquisition &mdash; sardana 2.5.0 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../../genindex.html"/>
        <link rel="search" title="Search" href="../../../search.html"/>
    <link rel="top" title="sardana 2.5.0 documentation" href="../../../index.html"/>
        <link rel="up" title="Module code" href="../../index.html"/> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> sardana
          

          
            
            <img src="../../../_static/logo.png" class="logo" />
          
          </a>

          
            
            
              <div class="version">
                2.5
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference external" href="http://www.sardana-controls.org">Home Page</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/sardana-org/sardana">Project Page</a></li>
<li class="toctree-l1"><a class="reference external" href="http://pypi.python.org/pypi/sardana">Download from PyPI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs.html">Documentation</a></li>
<li class="toctree-l1"><a class="reference external" href="http://github.com/sardana-org/sardana/wiki">Wiki</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../index.html">sardana</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      
    <li>sardana.pool.poolacquisition</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for sardana.pool.poolacquisition</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>

<span class="c1">##############################################################################</span>
<span class="c1">##</span>
<span class="c1"># This file is part of Sardana</span>
<span class="c1">##</span>
<span class="c1"># http://www.sardana-controls.org/</span>
<span class="c1">##</span>
<span class="c1"># Copyright 2011 CELLS / ALBA Synchrotron, Bellaterra, Spain</span>
<span class="c1">##</span>
<span class="c1"># Sardana is free software: you can redistribute it and/or modify</span>
<span class="c1"># it under the terms of the GNU Lesser General Public License as published by</span>
<span class="c1"># the Free Software Foundation, either version 3 of the License, or</span>
<span class="c1"># (at your option) any later version.</span>
<span class="c1">##</span>
<span class="c1"># Sardana is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># GNU Lesser General Public License for more details.</span>
<span class="c1">##</span>
<span class="c1"># You should have received a copy of the GNU Lesser General Public License</span>
<span class="c1"># along with Sardana.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="c1">##</span>
<span class="c1">##############################################################################</span>

<span class="sd">&quot;&quot;&quot;This module is part of the Python Pool libray. It defines the class for an</span>
<span class="sd">acquisition&quot;&quot;&quot;</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;AcquisitionState&quot;</span><span class="p">,</span> <span class="s2">&quot;AcquisitionMap&quot;</span><span class="p">,</span> <span class="s2">&quot;PoolCTAcquisition&quot;</span><span class="p">,</span>
           <span class="s2">&quot;Pool0DAcquisition&quot;</span><span class="p">,</span> <span class="s2">&quot;Channel&quot;</span><span class="p">,</span> <span class="s2">&quot;PoolIORAcquisition&quot;</span><span class="p">]</span>

<span class="n">__docformat__</span> <span class="o">=</span> <span class="s1">&#39;restructuredtext&#39;</span>

<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">datetime</span>

<span class="kn">from</span> <span class="nn">taurus.core.util.log</span> <span class="k">import</span> <span class="n">DebugIt</span>
<span class="kn">from</span> <span class="nn">taurus.core.util.enumeration</span> <span class="k">import</span> <span class="n">Enumeration</span>

<span class="kn">from</span> <span class="nn">sardana</span> <span class="k">import</span> <span class="n">SardanaValue</span><span class="p">,</span> <span class="n">State</span><span class="p">,</span> <span class="n">ElementType</span><span class="p">,</span> <span class="n">TYPE_TIMERABLE_ELEMENTS</span>
<span class="kn">from</span> <span class="nn">sardana.sardanathreadpool</span> <span class="k">import</span> <span class="n">get_thread_pool</span>
<span class="kn">from</span> <span class="nn">sardana.pool</span> <span class="k">import</span> <span class="n">SynchParam</span><span class="p">,</span> <span class="n">SynchDomain</span><span class="p">,</span> <span class="n">AcqSynch</span>
<span class="kn">from</span> <span class="nn">sardana.pool.poolaction</span> <span class="k">import</span> <span class="n">ActionContext</span><span class="p">,</span> <span class="n">PoolActionItem</span><span class="p">,</span> <span class="n">PoolAction</span>
<span class="kn">from</span> <span class="nn">sardana.pool.poolsynchronization</span> <span class="k">import</span> <span class="n">PoolSynchronization</span>

<span class="c1">#: enumeration representing possible motion states</span>
<span class="n">AcquisitionState</span> <span class="o">=</span> <span class="n">Enumeration</span><span class="p">(</span><span class="s2">&quot;AcquisitionState&quot;</span><span class="p">,</span> <span class="p">(</span>
    <span class="s2">&quot;Stopped&quot;</span><span class="p">,</span>
    <span class="c1">#    &quot;StoppedOnError&quot;,</span>
    <span class="c1">#    &quot;StoppedOnAbort&quot;,</span>
    <span class="s2">&quot;Acquiring&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Invalid&quot;</span><span class="p">))</span>

<span class="n">AS</span> <span class="o">=</span> <span class="n">AcquisitionState</span>
<span class="n">AcquiringStates</span> <span class="o">=</span> <span class="n">AS</span><span class="o">.</span><span class="n">Acquiring</span><span class="p">,</span>
<span class="n">StoppedStates</span> <span class="o">=</span> <span class="n">AS</span><span class="o">.</span><span class="n">Stopped</span><span class="p">,</span>  <span class="c1"># MS.StoppedOnError, MS.StoppedOnAbort</span>

<span class="n">AcquisitionMap</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># AS.Stopped           : State.On,</span>
    <span class="n">AS</span><span class="o">.</span><span class="n">Acquiring</span><span class="p">:</span> <span class="n">State</span><span class="o">.</span><span class="n">Moving</span><span class="p">,</span>
    <span class="n">AS</span><span class="o">.</span><span class="n">Invalid</span><span class="p">:</span> <span class="n">State</span><span class="o">.</span><span class="n">Invalid</span><span class="p">,</span>
<span class="p">}</span>


<span class="k">def</span> <span class="nf">split_MGConfigurations</span><span class="p">(</span><span class="n">mg_cfg_in</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Split MeasurementGroup configuration with channels</span>
<span class="sd">    triggered by SW Trigger and channels triggered by HW trigger</span>

<span class="sd">    TODO: (technical debt) All the MeasurementGroup configuration</span>
<span class="sd">    logic should be encapsulate in a dedicated class instead of</span>
<span class="sd">    using a basic data structures like dict or lists...</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ctrls_in</span> <span class="o">=</span> <span class="n">mg_cfg_in</span><span class="p">[</span><span class="s1">&#39;controllers&#39;</span><span class="p">]</span>
    <span class="n">mg_sw_cfg_out</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">mg_0d_cfg_out</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">mg_hw_cfg_out</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">mg_sw_cfg_out</span><span class="p">[</span><span class="s1">&#39;controllers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctrls_sw_out</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">mg_0d_cfg_out</span><span class="p">[</span><span class="s1">&#39;controllers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctrls_0d_out</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">mg_hw_cfg_out</span><span class="p">[</span><span class="s1">&#39;controllers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctrls_hw_out</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">ctrl</span><span class="p">,</span> <span class="n">ctrl_info</span> <span class="ow">in</span> <span class="n">ctrls_in</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">external</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;__&#39;</span><span class="p">)</span>
        <span class="c1"># skipping external controllers e.g. Tango attributes</span>
        <span class="k">if</span> <span class="n">external</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="c1"># splitting ZeroD based on the type</span>
        <span class="k">if</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">get_ctrl_types</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">ElementType</span><span class="o">.</span><span class="n">ZeroDExpChannel</span><span class="p">:</span>
            <span class="n">ctrls_0d_out</span><span class="p">[</span><span class="n">ctrl</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctrl_info</span>
        <span class="c1"># ignoring PseudoCounter</span>
        <span class="k">elif</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">get_ctrl_types</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">ElementType</span><span class="o">.</span><span class="n">PseudoCounter</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="c1"># splitting rest of the channels based on the assigned trigger</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">synchronizer</span> <span class="o">=</span> <span class="n">ctrl_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;synchronizer&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">synchronizer</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">synchronizer</span> <span class="o">==</span> <span class="s1">&#39;software&#39;</span><span class="p">:</span>
                <span class="n">ctrls_sw_out</span><span class="p">[</span><span class="n">ctrl</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctrl_info</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ctrls_hw_out</span><span class="p">[</span><span class="n">ctrl</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctrl_info</span>

    <span class="k">def</span> <span class="nf">find_master</span><span class="p">(</span><span class="n">ctrls</span><span class="p">,</span> <span class="n">role</span><span class="p">):</span>
        <span class="n">master_idx</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;+inf&quot;</span><span class="p">)</span>
        <span class="n">master</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">ctrl_info</span> <span class="ow">in</span> <span class="n">ctrls</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">element</span> <span class="o">=</span> <span class="n">ctrl_info</span><span class="p">[</span><span class="n">role</span><span class="p">]</span>
            <span class="n">element_idx</span> <span class="o">=</span> <span class="n">ctrl_info</span><span class="p">[</span><span class="s2">&quot;channels&quot;</span><span class="p">][</span><span class="n">element</span><span class="p">][</span><span class="s2">&quot;index&quot;</span><span class="p">]</span>
            <span class="n">element_enabled</span> <span class="o">=</span> <span class="n">ctrl_info</span><span class="p">[</span><span class="s2">&quot;channels&quot;</span><span class="p">][</span><span class="n">element</span><span class="p">][</span><span class="s2">&quot;enabled&quot;</span><span class="p">]</span>
            <span class="c1"># Find master only if is enabled</span>
            <span class="k">if</span> <span class="n">element_idx</span> <span class="o">&lt;</span> <span class="n">master_idx</span> <span class="ow">and</span> <span class="n">element_enabled</span><span class="p">:</span>
                <span class="n">master</span> <span class="o">=</span> <span class="n">element</span>
                <span class="n">master_idx</span> <span class="o">=</span> <span class="n">element_idx</span>
        <span class="k">return</span> <span class="n">master</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ctrls_sw_out</span><span class="p">):</span>
        <span class="n">mg_sw_cfg_out</span><span class="p">[</span><span class="s2">&quot;timer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">find_master</span><span class="p">(</span><span class="n">ctrls_sw_out</span><span class="p">,</span> <span class="s2">&quot;timer&quot;</span><span class="p">)</span>
        <span class="n">mg_sw_cfg_out</span><span class="p">[</span><span class="s2">&quot;monitor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">find_master</span><span class="p">(</span><span class="n">ctrls_sw_out</span><span class="p">,</span> <span class="s2">&quot;monitor&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ctrls_hw_out</span><span class="p">):</span>
        <span class="n">mg_hw_cfg_out</span><span class="p">[</span><span class="s2">&quot;timer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">find_master</span><span class="p">(</span><span class="n">ctrls_hw_out</span><span class="p">,</span> <span class="s2">&quot;timer&quot;</span><span class="p">)</span>
        <span class="n">mg_hw_cfg_out</span><span class="p">[</span><span class="s2">&quot;monitor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">find_master</span><span class="p">(</span><span class="n">ctrls_hw_out</span><span class="p">,</span> <span class="s2">&quot;monitor&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">mg_hw_cfg_out</span><span class="p">,</span> <span class="n">mg_sw_cfg_out</span><span class="p">,</span> <span class="n">mg_0d_cfg_out</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">getTGConfiguration</span><span class="p">(</span><span class="n">MGcfg</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Build TG configuration from complete MG configuration.</span>

<span class="sd">    TODO: (technical debt) All the MeasurementGroup configuration</span>
<span class="sd">    logic should be encapsulate in a dedicated class instead of</span>
<span class="sd">    using a basic data structures like dict or lists...</span>

<span class="sd">    :param MGcfg: configuration dictionary of the whole Measurement Group.</span>
<span class="sd">    :type MGcfg: dict&lt;&gt;</span>
<span class="sd">    :return: a configuration dictionary of TG elements organized by controller</span>
<span class="sd">    :rtype: dict&lt;&gt;</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1"># Create list with not repeated elements</span>
    <span class="n">_tg_element_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">ctrl</span> <span class="ow">in</span> <span class="n">MGcfg</span><span class="p">[</span><span class="s2">&quot;controllers&quot;</span><span class="p">]:</span>
        <span class="n">tg_element</span> <span class="o">=</span> <span class="n">MGcfg</span><span class="p">[</span><span class="s2">&quot;controllers&quot;</span><span class="p">][</span><span class="n">ctrl</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;synchronizer&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">tg_element</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
                <span class="n">tg_element</span> <span class="o">!=</span> <span class="s2">&quot;software&quot;</span> <span class="ow">and</span>
                <span class="n">tg_element</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_tg_element_list</span><span class="p">):</span>
            <span class="n">_tg_element_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tg_element</span><span class="p">)</span>

    <span class="c1"># Intermediate dictionary to organize each ctrl with its elements.</span>
    <span class="n">ctrl_tgelem_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">tgelem</span> <span class="ow">in</span> <span class="n">_tg_element_list</span><span class="p">:</span>
        <span class="n">tg_ctrl</span> <span class="o">=</span> <span class="n">tgelem</span><span class="o">.</span><span class="n">get_controller</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">tg_ctrl</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ctrl_tgelem_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">ctrl_tgelem_dict</span><span class="p">[</span><span class="n">tg_ctrl</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">tgelem</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ctrl_tgelem_dict</span><span class="p">[</span><span class="n">tg_ctrl</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tgelem</span><span class="p">)</span>

    <span class="c1"># Build TG configuration dictionary.</span>
    <span class="n">TGcfg</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">TGcfg</span><span class="p">[</span><span class="s1">&#39;controllers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">ctrl</span> <span class="ow">in</span> <span class="n">ctrl_tgelem_dict</span><span class="p">:</span>
        <span class="n">TGcfg</span><span class="p">[</span><span class="s1">&#39;controllers&#39;</span><span class="p">][</span><span class="n">ctrl</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctrls</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">ctrls</span><span class="p">[</span><span class="s1">&#39;channels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">tg_elem</span> <span class="ow">in</span> <span class="n">ctrl_tgelem_dict</span><span class="p">[</span><span class="n">ctrl</span><span class="p">]:</span>
            <span class="n">ch</span> <span class="o">=</span> <span class="n">ctrls</span><span class="p">[</span><span class="s1">&#39;channels&#39;</span><span class="p">][</span><span class="n">tg_elem</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">ch</span><span class="p">[</span><span class="s1">&#39;full_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tg_elem</span><span class="o">.</span><span class="n">full_name</span>
    <span class="c1"># TODO: temporary returning tg_elements</span>
    <span class="k">return</span> <span class="n">TGcfg</span><span class="p">,</span> <span class="n">_tg_element_list</span>


<span class="k">def</span> <span class="nf">extract_integ_time</span><span class="p">(</span><span class="n">synchronization</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Extract integration time(s) from synchronization dict. If there is only</span>
<span class="sd">    one group in the synchronization than returns float with the integration</span>
<span class="sd">    time. Otherwise a list of floats with different integration times.</span>

<span class="sd">    TODO: (technical debt) All the MeasurementGroup synchronization</span>
<span class="sd">    logic should be encapsulate in a dedicated class instead of</span>
<span class="sd">    using a basic data structures like dict or lists...</span>

<span class="sd">    :param synchronization: group(s) where each group is described by</span>
<span class="sd">        SynchParam(s)</span>
<span class="sd">    :type synchronization: list(dict)</span>
<span class="sd">    :return list(float) or float</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">synchronization</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">integ_time</span> <span class="o">=</span> <span class="n">synchronization</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">SynchParam</span><span class="o">.</span><span class="n">Active</span><span class="p">][</span><span class="n">SynchDomain</span><span class="o">.</span><span class="n">Time</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">integ_time</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">synchronization</span><span class="p">:</span>
            <span class="n">active_time</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="n">SynchParam</span><span class="o">.</span><span class="n">Active</span><span class="p">][</span><span class="n">SynchDomain</span><span class="o">.</span><span class="n">Time</span><span class="p">]</span>
            <span class="n">repeats</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="n">SynchParam</span><span class="o">.</span><span class="n">Repeats</span><span class="p">]</span>
            <span class="n">integ_time</span> <span class="o">+=</span> <span class="p">[</span><span class="n">active_time</span><span class="p">]</span> <span class="o">*</span> <span class="n">repeats</span>
    <span class="k">return</span> <span class="n">integ_time</span>


<span class="k">def</span> <span class="nf">extract_repetitions</span><span class="p">(</span><span class="n">synchronization</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Extract repetitions from synchronization dict.</span>

<span class="sd">    TODO: (technical debt) All the MeasurementGroup synchronization</span>
<span class="sd">    logic should be encapsulate in a dedicated class instead of</span>
<span class="sd">    using a basic data structures like dict or lists...</span>

<span class="sd">    :param synchronization: group(s) where each group is described by</span>
<span class="sd">        SynchParam(s)</span>
<span class="sd">    :type synchronization: list(dict)</span>
<span class="sd">    :return: number of repetitions</span>
<span class="sd">    :rtype: int</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">repetitions</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">synchronization</span><span class="p">:</span>
        <span class="n">repetitions</span> <span class="o">+=</span> <span class="n">group</span><span class="p">[</span><span class="n">SynchParam</span><span class="o">.</span><span class="n">Repeats</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">repetitions</span>


<span class="k">def</span> <span class="nf">is_value_error</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">SardanaValue</span><span class="p">)</span> <span class="ow">and</span> <span class="n">value</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="kc">False</span>


<span class="k">class</span> <span class="nc">PoolAcquisition</span><span class="p">(</span><span class="n">PoolAction</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">main_element</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Acquisition&quot;</span><span class="p">):</span>
        <span class="n">PoolAction</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">main_element</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="n">zerodname</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;.0DAcquisition&quot;</span>
        <span class="n">hwname</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;.HardwareAcquisition&quot;</span>
        <span class="n">swname</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;.SoftwareAcquisition&quot;</span>
        <span class="n">synchname</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;.Synchronization&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sw_acq_config</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_0d_config</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_0d_acq</span> <span class="o">=</span> <span class="n">Pool0DAcquisition</span><span class="p">(</span><span class="n">main_element</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">zerodname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sw_acq</span> <span class="o">=</span> <span class="n">PoolAcquisitionSoftware</span><span class="p">(</span><span class="n">main_element</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">swname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hw_acq</span> <span class="o">=</span> <span class="n">PoolAcquisitionHardware</span><span class="p">(</span><span class="n">main_element</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">hwname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_synch</span> <span class="o">=</span> <span class="n">PoolSynchronization</span><span class="p">(</span><span class="n">main_element</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">synchname</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_sw_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sw_acq_config</span> <span class="o">=</span> <span class="n">config</span>

    <span class="k">def</span> <span class="nf">set_0d_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_0d_config</span> <span class="o">=</span> <span class="n">config</span>

    <span class="k">def</span> <span class="nf">event_received</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">args</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">type_</span><span class="o">.</span><span class="n">name</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;state&quot;</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">t_fmt</span> <span class="o">=</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S.</span><span class="si">%f</span><span class="s1">&#39;</span>
        <span class="n">t_str</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">t_fmt</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> event with id: </span><span class="si">%d</span><span class="s1"> received at: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">t_str</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;active&quot;</span><span class="p">:</span>
            <span class="c1"># this code is not thread safe, but for the moment we assume that</span>
            <span class="c1"># only one EventGenerator will work at the same time</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sw_acq_config</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sw_acq</span><span class="o">.</span><span class="n">_is_started</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sw_acq</span><span class="o">.</span><span class="n">is_running</span><span class="p">():</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Skipping trigger: software acquisition is still&#39;</span>
                           <span class="s1">&#39; in progress.&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Executing software acquisition.&#39;</span><span class="p">)</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="p">()</span>
                    <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sw_acq_config</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;synch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_sw_acq</span><span class="o">.</span><span class="n">_started</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">get_thread_pool</span><span class="p">()</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sw_acq</span><span class="o">.</span><span class="n">run</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_0d_config</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_0d_acq</span><span class="o">.</span><span class="n">_is_started</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_0d_acq</span><span class="o">.</span><span class="n">is_running</span><span class="p">():</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Skipping trigger: ZeroD acquisition is still in&#39;</span>
                           <span class="s1">&#39; progress.&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Executing ZeroD acquisition.&#39;</span><span class="p">)</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="p">()</span>
                    <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_0d_config</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;synch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_0d_acq</span><span class="o">.</span><span class="n">_started</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_0d_acq</span><span class="o">.</span><span class="n">_stopped</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_0d_acq</span><span class="o">.</span><span class="n">_aborted</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">get_thread_pool</span><span class="p">()</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_0d_acq</span><span class="o">.</span><span class="n">run</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;passive&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_0d_config</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_0d_acq</span><span class="o">.</span><span class="n">_is_started</span><span class="p">()</span> <span class="ow">or</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_0d_acq</span><span class="o">.</span><span class="n">is_running</span><span class="p">()):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Stopping ZeroD acquisition.&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_0d_acq</span><span class="o">.</span><span class="n">stop_action</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">is_running</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_0d_acq</span><span class="o">.</span><span class="n">is_running</span><span class="p">()</span> <span class="ow">or</span>\
            <span class="bp">self</span><span class="o">.</span><span class="n">_sw_acq</span><span class="o">.</span><span class="n">is_running</span><span class="p">()</span> <span class="ow">or</span>\
            <span class="bp">self</span><span class="o">.</span><span class="n">_hw_acq</span><span class="o">.</span><span class="n">is_running</span><span class="p">()</span> <span class="ow">or</span>\
            <span class="bp">self</span><span class="o">.</span><span class="n">_synch</span><span class="o">.</span><span class="n">is_running</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_elements</span><span class="p">():</span>
            <span class="n">elem</span><span class="o">.</span><span class="n">put_state</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="c1"># TODO: temporarily clear value buffers at the beginning of the</span>
            <span class="c1"># acquisition instead of doing it in the finish hook of each</span>
            <span class="c1"># acquisition sub-actions. See extensive explanation in the</span>
            <span class="c1"># constructor of PoolAcquisitionBase.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">elem</span><span class="o">.</span><span class="n">clear_value_buffer</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># clean also the pseudo counters, even the ones that do not</span>
            <span class="c1"># participate directly in the acquisition</span>
            <span class="k">for</span> <span class="n">pseudo_elem</span> <span class="ow">in</span> <span class="n">elem</span><span class="o">.</span><span class="n">get_pseudo_elements</span><span class="p">():</span>
                <span class="n">pseudo_elem</span><span class="o">.</span><span class="n">clear_value_buffer</span><span class="p">()</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">]</span>
        <span class="n">synchronization</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;synchronization&quot;</span><span class="p">]</span>
        <span class="n">integ_time</span> <span class="o">=</span> <span class="n">extract_integ_time</span><span class="p">(</span><span class="n">synchronization</span><span class="p">)</span>
        <span class="n">repetitions</span> <span class="o">=</span> <span class="n">extract_repetitions</span><span class="p">(</span><span class="n">synchronization</span><span class="p">)</span>
        <span class="c1"># TODO: this code splits the global mg configuration into</span>
        <span class="c1"># experimental channels triggered by hw and experimental channels</span>
        <span class="c1"># triggered by sw. Refactor it!!!!</span>
        <span class="p">(</span><span class="n">hw_acq_cfg</span><span class="p">,</span> <span class="n">sw_acq_cfg</span><span class="p">,</span> <span class="n">zerod_acq_cfg</span><span class="p">)</span> <span class="o">=</span> <span class="n">split_MGConfigurations</span><span class="p">(</span>
            <span class="n">config</span><span class="p">)</span>
        <span class="n">synch_cfg</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">getTGConfiguration</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="c1"># starting continuous acquisition only if there are any controllers</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hw_acq_cfg</span><span class="p">[</span><span class="s1">&#39;controllers&#39;</span><span class="p">]):</span>
            <span class="n">cont_acq_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">cont_acq_kwargs</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hw_acq_cfg</span>
            <span class="n">cont_acq_kwargs</span><span class="p">[</span><span class="s1">&#39;integ_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">integ_time</span>
            <span class="n">cont_acq_kwargs</span><span class="p">[</span><span class="s1">&#39;repetitions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">repetitions</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_hw_acq</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">cont_acq_kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sw_acq_cfg</span><span class="p">[</span><span class="s1">&#39;controllers&#39;</span><span class="p">])</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">zerod_acq_cfg</span><span class="p">[</span><span class="s1">&#39;controllers&#39;</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_synch</span><span class="o">.</span><span class="n">add_listener</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sw_acq_cfg</span><span class="p">[</span><span class="s1">&#39;controllers&#39;</span><span class="p">]):</span>
                <span class="n">sw_acq_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="n">sw_acq_kwargs</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sw_acq_cfg</span>
                <span class="n">sw_acq_kwargs</span><span class="p">[</span><span class="s1">&#39;integ_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">integ_time</span>
                <span class="n">sw_acq_kwargs</span><span class="p">[</span><span class="s1">&#39;repetitions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_sw_config</span><span class="p">(</span><span class="n">sw_acq_kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">zerod_acq_cfg</span><span class="p">[</span><span class="s1">&#39;controllers&#39;</span><span class="p">]):</span>
                <span class="n">zerod_acq_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="n">zerod_acq_kwargs</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">zerod_acq_cfg</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_0d_config</span><span class="p">(</span><span class="n">zerod_acq_kwargs</span><span class="p">)</span>
        <span class="n">synch_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">synch_kwargs</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">synch_cfg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_synch</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">synch_kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_action_for_element</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">):</span>
        <span class="n">elem_type</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">get_type</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">elem_type</span> <span class="ow">in</span> <span class="n">TYPE_TIMERABLE_ELEMENTS</span><span class="p">:</span>
            <span class="n">main_element</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_element</span>
            <span class="n">channel_to_acq_synch</span> <span class="o">=</span> <span class="n">main_element</span><span class="o">.</span><span class="n">_channel_to_acq_synch</span>
            <span class="n">acq_synch</span> <span class="o">=</span> <span class="n">channel_to_acq_synch</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">acq_synch</span> <span class="ow">in</span> <span class="p">(</span><span class="n">AcqSynch</span><span class="o">.</span><span class="n">SoftwareTrigger</span><span class="p">,</span>
                             <span class="n">AcqSynch</span><span class="o">.</span><span class="n">SoftwareGate</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sw_acq</span>
            <span class="k">elif</span> <span class="n">acq_synch</span> <span class="ow">in</span> <span class="p">(</span><span class="n">AcqSynch</span><span class="o">.</span><span class="n">HardwareTrigger</span><span class="p">,</span>
                               <span class="n">AcqSynch</span><span class="o">.</span><span class="n">HardwareGate</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hw_acq</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># by default software synchronization is in use</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sw_acq</span>
        <span class="k">elif</span> <span class="n">elem_type</span> <span class="o">==</span> <span class="n">ElementType</span><span class="o">.</span><span class="n">ZeroDExpChannel</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_0d_acq</span>
        <span class="k">elif</span> <span class="n">elem_type</span> <span class="o">==</span> <span class="n">ElementType</span><span class="o">.</span><span class="n">TriggerGate</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_synch</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Could not determine action for element </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                               <span class="n">element</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">clear_elements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Clears all elements from this action&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">add_element</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds a new element to this action.</span>

<span class="sd">        :param element: the new element to be added</span>
<span class="sd">        :type element: sardana.pool.poolelement.PoolElement&quot;&quot;&quot;</span>
        <span class="n">action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_action_for_element</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
        <span class="n">action</span><span class="o">.</span><span class="n">add_element</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">remove_element</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Removes an element from this action. If the element is not part of</span>
<span class="sd">        this action, a ValueError is raised.</span>

<span class="sd">        :param element: the new element to be removed</span>
<span class="sd">        :type element: sardana.pool.poolelement.PoolElement</span>

<span class="sd">        :raises: ValueError&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_acq_for_element</span><span class="p">(</span><span class="n">element</span><span class="p">):</span>
            <span class="n">action</span><span class="o">.</span><span class="n">remove_element</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_elements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">copy_of</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a sequence of all elements involved in this action.</span>

<span class="sd">        :param copy_of: If False (default) the internal container of</span>
<span class="sd">                        elements is returned. If True, a copy of the</span>
<span class="sd">                        internal container is returned instead</span>
<span class="sd">        :type copy_of: bool</span>
<span class="sd">        :return: a sequence of all elements involved in this action.</span>
<span class="sd">        :rtype: seq&lt;sardana.pool.poolelement.PoolElement&gt;&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hw_acq</span><span class="o">.</span><span class="n">get_elements</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sw_acq</span><span class="o">.</span><span class="n">get_elements</span><span class="p">()</span> <span class="o">+</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_0d_acq</span><span class="o">.</span><span class="n">get_elements</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_synch</span><span class="o">.</span><span class="n">get_elements</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">get_pool_controller_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a list of all controller elements involved in this action.</span>

<span class="sd">        :return: a list of all controller elements involved in this action.</span>
<span class="sd">        :rtype: list&lt;sardana.pool.poolelement.PoolController&gt;&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pool_ctrl_list</span>

    <span class="k">def</span> <span class="nf">get_pool_controllers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a dict of all controller elements involved in this action.</span>

<span class="sd">        :return: a dict of all controller elements involved in this action.</span>
<span class="sd">        :rtype: dict&lt;sardana.pool.poolelement.PoolController,</span>
<span class="sd">                seq&lt;sardana.pool.poolelement.PoolElement&gt;&gt;&quot;&quot;&quot;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hw_acq</span><span class="o">.</span><span class="n">get_pool_controllers</span><span class="p">())</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sw_acq</span><span class="o">.</span><span class="n">get_pool_controllers</span><span class="p">())</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_0d_acq</span><span class="o">.</span><span class="n">get_pool_controllers</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span> <span class="nf">read_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ret</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">serial</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reads value information of all elements involved in this action</span>

<span class="sd">        :param ret: output map parameter that should be filled with value</span>
<span class="sd">                    information. If None is given (default), a new map is</span>
<span class="sd">                    created an returned</span>
<span class="sd">        :type ret: dict</span>
<span class="sd">        :param serial: If False (default) perform controller HW value requests</span>
<span class="sd">                       in parallel. If True, access is serialized.</span>
<span class="sd">        :type serial: bool</span>
<span class="sd">        :return: a map containing value information per element</span>
<span class="sd">        :rtype: dict&lt;:class:~`sardana.pool.poolelement.PoolElement`,</span>
<span class="sd">                     :class:~`sardana.sardanavalue.SardanaValue`&gt;&quot;&quot;&quot;</span>
        <span class="c1"># TODO: this is broken now - fix it</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ct_acq</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="n">ret</span><span class="o">=</span><span class="n">ret</span><span class="p">,</span> <span class="n">serial</span><span class="o">=</span><span class="n">serial</span><span class="p">)</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_0d_acq</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="n">ret</span><span class="o">=</span><span class="n">ret</span><span class="p">,</span> <span class="n">serial</span><span class="o">=</span><span class="n">serial</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">ret</span>


<span class="k">class</span> <span class="nc">Channel</span><span class="p">(</span><span class="n">PoolActionItem</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">acquirable</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">PoolActionItem</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">acquirable</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">info</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">PoolAcquisitionBase</span><span class="p">(</span><span class="n">PoolAction</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for acquisitions with a generic start_action method.</span>

<span class="sd">    .. note::</span>
<span class="sd">        The PoolAcquisitionBase class has been included in Sardana</span>
<span class="sd">        on a provisional basis. Backwards incompatible changes</span>
<span class="sd">        (up to and including removal of the module) may occur if</span>
<span class="sd">        deemed necessary by the core developers.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">main_element</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">PoolAction</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">main_element</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_channels</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># TODO: for the moment we can not clear value buffers at the end of</span>
        <span class="c1"># the acquisition. This is because of the pseudo counters that are</span>
        <span class="c1"># based on channels synchronized by hardware and software.</span>
        <span class="c1"># These two acquisition actions finish at different moment so the</span>
        <span class="c1"># pseudo counter will loose the value buffer of some of its physicals</span>
        <span class="c1"># if we clear the buffer at the end.</span>
        <span class="c1"># Whenever there will be solution for that, after refactoring of the</span>
        <span class="c1"># acquisition actions, uncomment this line</span>
        <span class="c1"># self.add_finish_hook(self.clear_value_buffers, True)</span>

    <span class="k">def</span> <span class="nf">in_acquisition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">states</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Determines if we are in acquisition or if the acquisition has ended</span>
<span class="sd">        based on the current unit trigger modes and states returned by the</span>
<span class="sd">        controller(s)</span>

<span class="sd">        :param states: a map containing state information as returned by</span>
<span class="sd">                       read_state_info</span>
<span class="sd">        :type states: dict&lt;PoolElement, State&gt;</span>
<span class="sd">        :return: returns True if in acquisition or False otherwise</span>
<span class="sd">        :rtype: bool&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">states</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">states</span><span class="p">[</span><span class="n">elem</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_in_action</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>

    <span class="nd">@DebugIt</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">start_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Prepares everything for acquisition and starts it.</span>
<span class="sd">        :param acq_sleep_time: sleep time between state queries</span>
<span class="sd">        :param nb_states_per_value: how many state queries between readouts</span>
<span class="sd">        :param integ_time: integration time(s)</span>
<span class="sd">        :type integ_time: float or seq&lt;float&gt;</span>
<span class="sd">        :param repetitions: repetitions</span>
<span class="sd">        :type repetitions: int</span>
<span class="sd">        :param config: configuration dictionary (with information about</span>
<span class="sd">            involved controllers and channels)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_aborted</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stopped</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_acq_sleep_time</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;acq_sleep_time&quot;</span><span class="p">,</span>
                                          <span class="n">pool</span><span class="o">.</span><span class="n">acq_loop_sleep_time</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nb_states_per_value</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;nb_states_per_value&quot;</span><span class="p">,</span>
                                               <span class="n">pool</span><span class="o">.</span><span class="n">acq_loop_states_per_value</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_integ_time</span> <span class="o">=</span> <span class="n">integ_time</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;integ_time&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mon_count</span> <span class="o">=</span> <span class="n">mon_count</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;monitor_count&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_repetitions</span> <span class="o">=</span> <span class="n">repetitions</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;repetitions&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">integ_time</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">mon_count</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;must give integration time or monitor counts&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">integ_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">mon_count</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;must give either integration time or monitor counts &quot;</span>
                   <span class="s2">&quot;(not both)&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">_</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;items&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_elements</span><span class="p">())</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">]</span>
        <span class="c1"># determine which is the controller which holds the master channel</span>

        <span class="k">if</span> <span class="n">integ_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">master_key</span> <span class="o">=</span> <span class="s1">&#39;timer&#39;</span>
            <span class="n">master_value</span> <span class="o">=</span> <span class="n">integ_time</span>
        <span class="k">if</span> <span class="n">mon_count</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">master_key</span> <span class="o">=</span> <span class="s1">&#39;monitor&#39;</span>
            <span class="n">master_value</span> <span class="o">=</span> <span class="o">-</span><span class="n">mon_count</span>
        <span class="n">master</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="n">master_key</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">master</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_element</span><span class="o">.</span><span class="n">set_state</span><span class="p">(</span><span class="n">State</span><span class="o">.</span><span class="n">Fault</span><span class="p">,</span> <span class="n">propagate</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;master </span><span class="si">{0}</span><span class="s2"> is unknown (probably disabled)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">master_key</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">master_ctrl</span> <span class="o">=</span> <span class="n">master</span><span class="o">.</span><span class="n">controller</span>

        <span class="n">pool_ctrls_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;controllers&#39;</span><span class="p">])</span>
        <span class="n">pool_ctrls_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;__tango__&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># controllers to be started (only enabled) in the right order</span>
        <span class="n">pool_ctrls</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># controllers that will be read at the end of the action</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pool_ctrl_dict_loop</span> <span class="o">=</span> <span class="n">_pool_ctrl_dict_loop</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># channels that are acquired (only enabled)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_channels</span> <span class="o">=</span> <span class="n">channels</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># select only suitable e.g. enabled, timerable controllers &amp; channels</span>
        <span class="k">for</span> <span class="n">ctrl</span><span class="p">,</span> <span class="n">pool_ctrl_data</span> <span class="ow">in</span> <span class="n">pool_ctrls_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># skip not timerable controllers e.g. 0D</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">is_timerable</span><span class="p">():</span>
                <span class="k">continue</span>
            <span class="n">ctrl_enabled</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">elements</span> <span class="o">=</span> <span class="n">pool_ctrl_data</span><span class="p">[</span><span class="s1">&#39;channels&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">element</span><span class="p">,</span> <span class="n">element_info</span> <span class="ow">in</span> <span class="n">elements</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># skip disabled elements</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">element_info</span><span class="p">[</span><span class="s1">&#39;enabled&#39;</span><span class="p">]:</span>
                    <span class="k">continue</span>
                <span class="c1"># Add only the enabled channels</span>
                <span class="n">channel</span> <span class="o">=</span> <span class="n">Channel</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="n">element_info</span><span class="p">)</span>
                <span class="n">channels</span><span class="p">[</span><span class="n">element</span><span class="p">]</span> <span class="o">=</span> <span class="n">channel</span>
                <span class="n">ctrl_enabled</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># check if the ctrl has enabled channels</span>
            <span class="k">if</span> <span class="n">ctrl_enabled</span><span class="p">:</span>
                <span class="c1"># enabled controller can no be offline</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">is_online</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">main_element</span><span class="o">.</span><span class="n">set_state</span><span class="p">(</span><span class="n">State</span><span class="o">.</span><span class="n">Fault</span><span class="p">,</span> <span class="n">propagate</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;controller </span><span class="si">{0}</span><span class="s2"> is offline&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ctrl</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="n">pool_ctrls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ctrl</span><span class="p">)</span>
                <span class="c1"># only CT will be read in the loop, 1D and 2D not</span>
                <span class="k">if</span> <span class="n">ElementType</span><span class="o">.</span><span class="n">CTExpChannel</span> <span class="ow">in</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">get_ctrl_types</span><span class="p">():</span>
                    <span class="n">_pool_ctrl_dict_loop</span><span class="p">[</span><span class="n">ctrl</span><span class="p">]</span> <span class="o">=</span> <span class="n">pool_ctrl_data</span>

        <span class="c1"># timer/monitor channels can not be disabled</span>
        <span class="k">for</span> <span class="n">pool_ctrl</span> <span class="ow">in</span> <span class="n">pool_ctrls</span><span class="p">:</span>
            <span class="n">ctrl</span> <span class="o">=</span> <span class="n">pool_ctrl</span><span class="o">.</span><span class="n">ctrl</span>
            <span class="n">pool_ctrl_data</span> <span class="o">=</span> <span class="n">pool_ctrls_dict</span><span class="p">[</span><span class="n">pool_ctrl</span><span class="p">]</span>
            <span class="n">timer_monitor</span> <span class="o">=</span> <span class="n">pool_ctrl_data</span><span class="p">[</span><span class="n">master_key</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">timer_monitor</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">main_element</span><span class="o">.</span><span class="n">set_state</span><span class="p">(</span><span class="n">State</span><span class="o">.</span><span class="n">Fault</span><span class="p">,</span> <span class="n">propagate</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;timer/monitor (</span><span class="si">{0}</span><span class="s2">) of </span><span class="si">{1}</span><span class="s2"> controller is &quot;</span>\
                      <span class="s2">&quot;disabled)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">timer_monitor</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">pool_ctrl</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># make sure the controller which has the master channel is the last to</span>
        <span class="c1"># be called</span>
        <span class="n">pool_ctrls</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">master_ctrl</span><span class="p">)</span>
        <span class="n">pool_ctrls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">master_ctrl</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">ActionContext</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="c1"># PreLoadAll, PreLoadOne, LoadOne and LoadAll</span>
            <span class="k">for</span> <span class="n">pool_ctrl</span> <span class="ow">in</span> <span class="n">pool_ctrls</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ctrl</span> <span class="o">=</span> <span class="n">pool_ctrl</span><span class="o">.</span><span class="n">ctrl</span>
                    <span class="n">pool_ctrl_data</span> <span class="o">=</span> <span class="n">pool_ctrls_dict</span><span class="p">[</span><span class="n">pool_ctrl</span><span class="p">]</span>
                    <span class="n">ctrl</span><span class="o">.</span><span class="n">PreLoadAll</span><span class="p">()</span>
                    <span class="n">master</span> <span class="o">=</span> <span class="n">pool_ctrl_data</span><span class="p">[</span><span class="n">master_key</span><span class="p">]</span>
                    <span class="n">axis</span> <span class="o">=</span> <span class="n">master</span><span class="o">.</span><span class="n">axis</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">res</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">PreLoadOne</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">master_value</span><span class="p">,</span> <span class="n">repetitions</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;PreLoadOne(axis, value) is deprecated since &quot;</span>
                               <span class="s2">&quot;version 2.3.0. Use PreLoadOne(axis, value, &quot;</span>
                               <span class="s2">&quot;repetitions) instead.&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="n">res</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">PreLoadOne</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">master_value</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.PreLoadOne(</span><span class="si">%d</span><span class="s2">) returned False&quot;</span> <span class="o">%</span>
                               <span class="p">(</span><span class="n">pool_ctrl</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">axis</span><span class="p">))</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">ctrl</span><span class="o">.</span><span class="n">LoadOne</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">master_value</span><span class="p">,</span> <span class="n">repetitions</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;LoadOne(axis, value) is deprecated since &quot;</span>
                               <span class="s2">&quot;version 2.3.0. Use LoadOne(axis, value, &quot;</span>
                               <span class="s2">&quot;repetitions) instead.&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="n">ctrl</span><span class="o">.</span><span class="n">LoadOne</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">master_value</span><span class="p">)</span>
                    <span class="n">ctrl</span><span class="o">.</span><span class="n">LoadAll</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">master</span><span class="o">.</span><span class="n">set_state</span><span class="p">(</span><span class="n">State</span><span class="o">.</span><span class="n">Fault</span><span class="p">,</span> <span class="n">propagate</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Load sequence of </span><span class="si">%s</span><span class="s2"> failed&quot;</span> <span class="o">%</span> <span class="n">pool_ctrl</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="c1"># PreStartAll on all enabled controllers</span>
            <span class="k">for</span> <span class="n">pool_ctrl</span> <span class="ow">in</span> <span class="n">pool_ctrls</span><span class="p">:</span>
                <span class="n">pool_ctrl</span><span class="o">.</span><span class="n">ctrl</span><span class="o">.</span><span class="n">PreStartAll</span><span class="p">()</span>

            <span class="c1"># PreStartOne &amp; StartOne on all enabled elements</span>
            <span class="k">for</span> <span class="n">pool_ctrl</span> <span class="ow">in</span> <span class="n">pool_ctrls</span><span class="p">:</span>
                <span class="n">ctrl</span> <span class="o">=</span> <span class="n">pool_ctrl</span><span class="o">.</span><span class="n">ctrl</span>
                <span class="n">pool_ctrl_data</span> <span class="o">=</span> <span class="n">pool_ctrls_dict</span><span class="p">[</span><span class="n">pool_ctrl</span><span class="p">]</span>
                <span class="n">elements</span> <span class="o">=</span> <span class="n">pool_ctrl_data</span><span class="p">[</span><span class="s1">&#39;channels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="n">timer_monitor</span> <span class="o">=</span> <span class="n">pool_ctrl_data</span><span class="p">[</span><span class="n">master_key</span><span class="p">]</span>
                <span class="c1"># make sure that the timer/monitor is started as the last one</span>
                <span class="n">elements</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">timer_monitor</span><span class="p">)</span>
                <span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">timer_monitor</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">elements</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">channel</span> <span class="o">=</span> <span class="n">channels</span><span class="p">[</span><span class="n">element</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">axis</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">axis</span>
                    <span class="n">ret</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">PreStartOne</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">master_value</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">ret</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.PreStartOne(</span><span class="si">%d</span><span class="s2">) returns False&quot;</span> <span class="o">%</span>
                               <span class="p">(</span><span class="n">pool_ctrl</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">axis</span><span class="p">))</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">ctrl</span><span class="o">.</span><span class="n">StartOne</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">master_value</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="n">element</span><span class="o">.</span><span class="n">set_state</span><span class="p">(</span><span class="n">State</span><span class="o">.</span><span class="n">Fault</span><span class="p">,</span> <span class="n">propagate</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.StartOne(</span><span class="si">%d</span><span class="s2">) failed&quot;</span> <span class="o">%</span>
                               <span class="p">(</span><span class="n">pool_ctrl</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">axis</span><span class="p">))</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="c1"># set the state of all elements to  and inform their listeners</span>
            <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">:</span>
                <span class="n">channel</span><span class="o">.</span><span class="n">set_state</span><span class="p">(</span><span class="n">State</span><span class="o">.</span><span class="n">Moving</span><span class="p">,</span> <span class="n">propagate</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

            <span class="c1"># StartAll on all enabled controllers</span>
            <span class="k">for</span> <span class="n">pool_ctrl</span> <span class="ow">in</span> <span class="n">pool_ctrls</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">pool_ctrl</span><span class="o">.</span><span class="n">ctrl</span><span class="o">.</span><span class="n">StartAll</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">elements</span> <span class="o">=</span> <span class="n">pool_ctrl_data</span><span class="p">[</span><span class="s1">&#39;channels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">elements</span><span class="p">:</span>
                        <span class="n">element</span><span class="o">.</span><span class="n">set_state</span><span class="p">(</span><span class="n">State</span><span class="o">.</span><span class="n">Fault</span><span class="p">,</span> <span class="n">propagate</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.StartAll() failed&quot;</span> <span class="o">%</span> <span class="n">pool_ctrl</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">clear_value_buffers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channels</span><span class="p">:</span>
            <span class="n">channel</span><span class="o">.</span><span class="n">clear_value_buffer</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">PoolAcquisitionHardware</span><span class="p">(</span><span class="n">PoolAcquisitionBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Acquisition action for controllers synchronized by hardware</span>

<span class="sd">    .. note::</span>
<span class="sd">        The PoolAcquisitionHardware class has been included in Sardana</span>
<span class="sd">        on a provisional basis. Backwards incompatible changes</span>
<span class="sd">        (up to and including removal of the module) may occur if</span>
<span class="sd">        deemed necessary by the core developers.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">main_element</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;AcquisitionHardware&quot;</span><span class="p">):</span>
        <span class="n">PoolAcquisitionBase</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">main_element</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="nd">@DebugIt</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">action_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">states</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channels</span><span class="p">:</span>
            <span class="n">states</span><span class="p">[</span><span class="n">element</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">values</span><span class="p">[</span><span class="n">element</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">nap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_acq_sleep_time</span>
        <span class="n">nb_states_per_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nb_states_per_value</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_state_info</span><span class="p">(</span><span class="n">ret</span><span class="o">=</span><span class="n">states</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_acquisition</span><span class="p">(</span><span class="n">states</span><span class="p">):</span>
                <span class="k">break</span>

            <span class="c1"># read value every n times</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span> <span class="o">%</span> <span class="n">nb_states_per_value</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">read_value_loop</span><span class="p">(</span><span class="n">ret</span><span class="o">=</span><span class="n">values</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">acquirable</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">is_value_error</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Loop read value error for </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                                   <span class="n">acquirable</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                        <span class="n">acquirable</span><span class="o">.</span><span class="n">put_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">acquirable</span><span class="o">.</span><span class="n">extend_value_buffer</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">nap</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">with</span> <span class="n">ActionContext</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">raw_read_state_info</span><span class="p">(</span><span class="n">ret</span><span class="o">=</span><span class="n">states</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">raw_read_value_loop</span><span class="p">(</span><span class="n">ret</span><span class="o">=</span><span class="n">values</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">acquirable</span><span class="p">,</span> <span class="n">state_info</span> <span class="ow">in</span> <span class="n">states</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># first update the element state so that value calculation</span>
            <span class="c1"># that is done after takes the updated state into account</span>
            <span class="n">acquirable</span><span class="o">.</span><span class="n">set_state_info</span><span class="p">(</span><span class="n">state_info</span><span class="p">,</span> <span class="n">propagate</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">acquirable</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">acquirable</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">is_value_error</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Loop final read value error for: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                               <span class="n">acquirable</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="n">acquirable</span><span class="o">.</span><span class="n">put_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">acquirable</span><span class="o">.</span><span class="n">extend_value_buffer</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">propagate</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">acquirable</span><span class="p">:</span>
                <span class="n">acquirable</span><span class="o">.</span><span class="n">clear_operation</span><span class="p">()</span>
                <span class="n">state_info</span> <span class="o">=</span> <span class="n">acquirable</span><span class="o">.</span><span class="n">_from_ctrl_state_info</span><span class="p">(</span><span class="n">state_info</span><span class="p">)</span>
                <span class="n">acquirable</span><span class="o">.</span><span class="n">set_state_info</span><span class="p">(</span><span class="n">state_info</span><span class="p">,</span> <span class="n">propagate</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">PoolAcquisitionSoftware</span><span class="p">(</span><span class="n">PoolAcquisitionBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Acquisition action for controllers synchronized by software</span>

<span class="sd">    .. note::</span>
<span class="sd">        The PoolAcquisitionSoftware class has been included in Sardana</span>
<span class="sd">        on a provisional basis. Backwards incompatible changes</span>
<span class="sd">        (up to and including removal of the module) may occur if</span>
<span class="sd">        deemed necessary by the core developers.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">main_element</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;AcquisitionSoftware&quot;</span><span class="p">,</span> <span class="n">slaves</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">PoolAcquisitionBase</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">main_element</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">slaves</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">slaves</span> <span class="o">=</span> <span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_slaves</span> <span class="o">=</span> <span class="n">slaves</span>

    <span class="nd">@DebugIt</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">start_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Prepares everything for acquisition and starts it.</span>
<span class="sd">        :param acq_sleep_time: sleep time between state queries</span>
<span class="sd">        :param nb_states_per_value: how many state queries between readouts</span>
<span class="sd">        :param integ_time: integration time(s)</span>
<span class="sd">        :type integ_time: float or seq&lt;float&gt;</span>
<span class="sd">        :param repetitions: repetitions</span>
<span class="sd">        :type repetitions: int</span>
<span class="sd">        :param config: configuration dictionary (with information about</span>
<span class="sd">            involved controllers and channels)</span>
<span class="sd">        :param index: trigger index that will be assigned to the acquired value</span>
<span class="sd">        :type index: int</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">PoolAcquisitionBase</span><span class="o">.</span><span class="n">start_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;idx&quot;</span><span class="p">)</span>

    <span class="nd">@DebugIt</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">action_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">states</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channels</span><span class="p">:</span>
            <span class="n">states</span><span class="p">[</span><span class="n">element</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">values</span><span class="p">[</span><span class="n">element</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">nap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_acq_sleep_time</span>
        <span class="n">nb_states_per_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nb_states_per_value</span>

        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_state_info</span><span class="p">(</span><span class="n">ret</span><span class="o">=</span><span class="n">states</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_acquisition</span><span class="p">(</span><span class="n">states</span><span class="p">):</span>
                <span class="k">break</span>

            <span class="c1"># read value every n times</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span> <span class="o">%</span> <span class="n">nb_states_per_value</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">read_value_loop</span><span class="p">(</span><span class="n">ret</span><span class="o">=</span><span class="n">values</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">acquirable</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">acquirable</span><span class="o">.</span><span class="n">put_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">nap</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">slave</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_slaves</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">slave</span><span class="o">.</span><span class="n">stop_action</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Unable to stop slave acquisition </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                             <span class="n">slave</span><span class="o">.</span><span class="n">getLogName</span><span class="p">())</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Details&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">ActionContext</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">raw_read_state_info</span><span class="p">(</span><span class="n">ret</span><span class="o">=</span><span class="n">states</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">raw_read_value_loop</span><span class="p">(</span><span class="n">ret</span><span class="o">=</span><span class="n">values</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">acquirable</span><span class="p">,</span> <span class="n">state_info</span> <span class="ow">in</span> <span class="n">states</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># first update the element state so that value calculation</span>
            <span class="c1"># that is done after takes the updated state into account</span>
            <span class="n">acquirable</span><span class="o">.</span><span class="n">set_state_info</span><span class="p">(</span><span class="n">state_info</span><span class="p">,</span> <span class="n">propagate</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">acquirable</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">acquirable</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">is_value_error</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Loop final read value error for: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                               <span class="n">acquirable</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">acquirable</span><span class="o">.</span><span class="n">append_value_buffer</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">acquirable</span><span class="p">:</span>
                <span class="n">acquirable</span><span class="o">.</span><span class="n">clear_operation</span><span class="p">()</span>
                <span class="n">state_info</span> <span class="o">=</span> <span class="n">acquirable</span><span class="o">.</span><span class="n">_from_ctrl_state_info</span><span class="p">(</span><span class="n">state_info</span><span class="p">)</span>
                <span class="n">acquirable</span><span class="o">.</span><span class="n">set_state_info</span><span class="p">(</span><span class="n">state_info</span><span class="p">,</span> <span class="n">propagate</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>


<div class="viewcode-block" id="PoolCTAcquisition"><a class="viewcode-back" href="../../../devel/api/sardana/pool/poolacquisition.html#sardana.pool.poolacquisition.PoolCTAcquisition">[docs]</a><span class="k">class</span> <span class="nc">PoolCTAcquisition</span><span class="p">(</span><span class="n">PoolAcquisitionBase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">main_element</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;CTAcquisition&quot;</span><span class="p">,</span> <span class="n">slaves</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_channels</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">slaves</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">slaves</span> <span class="o">=</span> <span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_slaves</span> <span class="o">=</span> <span class="n">slaves</span>

        <span class="n">PoolAcquisitionBase</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">main_element</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

<div class="viewcode-block" id="PoolCTAcquisition.get_read_value_loop_ctrls"><a class="viewcode-back" href="../../../devel/api/sardana/pool/poolacquisition.html#sardana.pool.poolacquisition.PoolCTAcquisition.get_read_value_loop_ctrls">[docs]</a>    <span class="k">def</span> <span class="nf">get_read_value_loop_ctrls</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pool_ctrl_dict_loop</span></div>

<div class="viewcode-block" id="PoolCTAcquisition.in_acquisition"><a class="viewcode-back" href="../../../devel/api/sardana/pool/poolacquisition.html#sardana.pool.poolacquisition.PoolCTAcquisition.in_acquisition">[docs]</a>    <span class="k">def</span> <span class="nf">in_acquisition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">states</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Determines if we are in acquisition or if the acquisition has ended</span>
<span class="sd">        based on the current unit trigger modes and states returned by the</span>
<span class="sd">        controller(s)</span>

<span class="sd">        :param states: a map containing state information as returned by</span>
<span class="sd">                       read_state_info</span>
<span class="sd">        :type states: dict&lt;PoolElement, State&gt;</span>
<span class="sd">        :return: returns True if in acquisition or False otherwise</span>
<span class="sd">        :rtype: bool&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">states</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">states</span><span class="p">[</span><span class="n">elem</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_in_action</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span></div>

    <span class="nd">@DebugIt</span><span class="p">()</span>
<div class="viewcode-block" id="PoolCTAcquisition.action_loop"><a class="viewcode-back" href="../../../devel/api/sardana/pool/poolacquisition.html#sardana.pool.poolacquisition.PoolCTAcquisition.action_loop">[docs]</a>    <span class="k">def</span> <span class="nf">action_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">states</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channels</span><span class="p">:</span>
            <span class="n">states</span><span class="p">[</span><span class="n">element</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># values[element] = None</span>

        <span class="n">nap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_acq_sleep_time</span>
        <span class="n">nb_states_per_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nb_states_per_value</span>

        <span class="c1"># read values to send a first event when starting to acquire</span>
        <span class="k">with</span> <span class="n">ActionContext</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">raw_read_value_loop</span><span class="p">(</span><span class="n">ret</span><span class="o">=</span><span class="n">values</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">acquirable</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">acquirable</span><span class="o">.</span><span class="n">put_value</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">propagate</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_state_info</span><span class="p">(</span><span class="n">ret</span><span class="o">=</span><span class="n">states</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_acquisition</span><span class="p">(</span><span class="n">states</span><span class="p">):</span>
                <span class="k">break</span>

            <span class="c1"># read value every n times</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span> <span class="o">%</span> <span class="n">nb_states_per_value</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">read_value_loop</span><span class="p">(</span><span class="n">ret</span><span class="o">=</span><span class="n">values</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">acquirable</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">acquirable</span><span class="o">.</span><span class="n">put_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">nap</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">slave</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_slaves</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">slave</span><span class="o">.</span><span class="n">stop_action</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Unable to stop slave acquisition </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                             <span class="n">slave</span><span class="o">.</span><span class="n">getLogName</span><span class="p">())</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Details&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">ActionContext</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">raw_read_state_info</span><span class="p">(</span><span class="n">ret</span><span class="o">=</span><span class="n">states</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">raw_read_value_loop</span><span class="p">(</span><span class="n">ret</span><span class="o">=</span><span class="n">values</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">acquirable</span><span class="p">,</span> <span class="n">state_info</span> <span class="ow">in</span> <span class="n">states</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># first update the element state so that value calculation</span>
            <span class="c1"># that is done after takes the updated state into account</span>
            <span class="n">acquirable</span><span class="o">.</span><span class="n">set_state_info</span><span class="p">(</span><span class="n">state_info</span><span class="p">,</span> <span class="n">propagate</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">acquirable</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">acquirable</span><span class="p">]</span>
                <span class="n">acquirable</span><span class="o">.</span><span class="n">put_value</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">propagate</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">acquirable</span><span class="p">:</span>
                <span class="n">acquirable</span><span class="o">.</span><span class="n">clear_operation</span><span class="p">()</span>
                <span class="n">state_info</span> <span class="o">=</span> <span class="n">acquirable</span><span class="o">.</span><span class="n">_from_ctrl_state_info</span><span class="p">(</span><span class="n">state_info</span><span class="p">)</span>
                <span class="n">acquirable</span><span class="o">.</span><span class="n">set_state_info</span><span class="p">(</span><span class="n">state_info</span><span class="p">,</span> <span class="n">propagate</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></div></div>


<span class="k">class</span> <span class="nc">Pool0DAcquisition</span><span class="p">(</span><span class="n">PoolAction</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">main_element</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;0DAcquisition&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_channels</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">PoolAction</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">main_element</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">start_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Prepares everything for acquisition and starts it.</span>

<span class="sd">           :param: config&quot;&quot;&quot;</span>

        <span class="n">pool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_index</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;idx&quot;</span><span class="p">)</span>

        <span class="c1"># prepare data structures</span>
        <span class="c1"># TODO: rollback this change when a proper synchronization between</span>
        <span class="c1"># acquisition actions will be develop.</span>
        <span class="c1"># Now the meta acquisition action is resettung them to 0.</span>
<span class="c1">#         self._aborted = False</span>
<span class="c1">#         self._stopped = False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_acq_sleep_time</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;acq_sleep_time&quot;</span><span class="p">,</span>
                                          <span class="n">pool</span><span class="o">.</span><span class="n">acq_loop_sleep_time</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nb_states_per_value</span> <span class="o">=</span> \
            <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;nb_states_per_value&quot;</span><span class="p">,</span>
                       <span class="n">pool</span><span class="o">.</span><span class="n">acq_loop_states_per_value</span><span class="p">)</span>

        <span class="n">items</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;items&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">items</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_elements</span><span class="p">()</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">]</span>

        <span class="n">pool_ctrls_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;controllers&#39;</span><span class="p">])</span>
        <span class="n">pool_ctrls_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;__tango__&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">pool_ctrls</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ctrl</span> <span class="ow">in</span> <span class="n">pool_ctrls_dict</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ElementType</span><span class="o">.</span><span class="n">ZeroDExpChannel</span> <span class="ow">in</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">get_ctrl_types</span><span class="p">():</span>
                <span class="n">pool_ctrls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ctrl</span><span class="p">)</span>

        <span class="c1"># Determine which channels are active</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_channels</span> <span class="o">=</span> <span class="n">channels</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">pool_ctrl</span> <span class="ow">in</span> <span class="n">pool_ctrls</span><span class="p">:</span>
            <span class="n">ctrl</span> <span class="o">=</span> <span class="n">pool_ctrl</span><span class="o">.</span><span class="n">ctrl</span>
            <span class="n">pool_ctrl_data</span> <span class="o">=</span> <span class="n">pool_ctrls_dict</span><span class="p">[</span><span class="n">pool_ctrl</span><span class="p">]</span>
            <span class="n">elements</span> <span class="o">=</span> <span class="n">pool_ctrl_data</span><span class="p">[</span><span class="s1">&#39;channels&#39;</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">element</span><span class="p">,</span> <span class="n">element_info</span> <span class="ow">in</span> <span class="n">elements</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">channel</span> <span class="o">=</span> <span class="n">Channel</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="n">element_info</span><span class="p">)</span>
                <span class="n">channels</span><span class="p">[</span><span class="n">element</span><span class="p">]</span> <span class="o">=</span> <span class="n">channel</span>

        <span class="k">with</span> <span class="n">ActionContext</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="c1"># set the state of all elements to  and inform their listeners</span>
            <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">:</span>
                <span class="n">channel</span><span class="o">.</span><span class="n">clear_buffer</span><span class="p">()</span>
                <span class="n">channel</span><span class="o">.</span><span class="n">set_state</span><span class="p">(</span><span class="n">State</span><span class="o">.</span><span class="n">Moving</span><span class="p">,</span> <span class="n">propagate</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">in_acquisition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">states</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Determines if we are in acquisition or if the acquisition has ended</span>
<span class="sd">        based on the current unit trigger modes and states returned by the</span>
<span class="sd">        controller(s)</span>

<span class="sd">        :param states: a map containing state information as returned by</span>
<span class="sd">                       read_state_info</span>
<span class="sd">        :type states: dict&lt;PoolElement, State&gt;</span>
<span class="sd">        :return: returns True if in acquisition or False otherwise</span>
<span class="sd">        :rtype: bool&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">states</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">states</span><span class="p">[</span><span class="n">state</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_in_action</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">action_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">states</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channels</span><span class="p">:</span>
            <span class="n">states</span><span class="p">[</span><span class="n">element</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">values</span><span class="p">[</span><span class="n">element</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">nap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_acq_sleep_time</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="n">ret</span><span class="o">=</span><span class="n">values</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">acquirable</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">acquirable</span><span class="o">.</span><span class="n">put_current_value</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">propagate</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stopped</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aborted</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">nap</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channels</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">accumulated_value</span><span class="o">.</span><span class="n">value_obj</span>
            <span class="n">element</span><span class="o">.</span><span class="n">append_value_buffer</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index</span><span class="p">,</span> <span class="n">propagate</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">ActionContext</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">raw_read_state_info</span><span class="p">(</span><span class="n">ret</span><span class="o">=</span><span class="n">states</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">acquirable</span><span class="p">,</span> <span class="n">state_info</span> <span class="ow">in</span> <span class="n">states</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># first update the element state so that value calculation</span>
            <span class="c1"># that is done after takes the updated state into account</span>
            <span class="n">state_info</span> <span class="o">=</span> <span class="n">acquirable</span><span class="o">.</span><span class="n">_from_ctrl_state_info</span><span class="p">(</span><span class="n">state_info</span><span class="p">)</span>
            <span class="n">acquirable</span><span class="o">.</span><span class="n">set_state_info</span><span class="p">(</span><span class="n">state_info</span><span class="p">,</span> <span class="n">propagate</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">acquirable</span><span class="p">:</span>
                <span class="n">acquirable</span><span class="o">.</span><span class="n">clear_operation</span><span class="p">()</span>
                <span class="n">acquirable</span><span class="o">.</span><span class="n">set_state_info</span><span class="p">(</span><span class="n">state_info</span><span class="p">,</span> <span class="n">propagate</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">stop_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Stop procedure for this action.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stopped</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">abort_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Aborts procedure for this action&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_aborted</span> <span class="o">=</span> <span class="kc">True</span>


<span class="k">class</span> <span class="nc">PoolIORAcquisition</span><span class="p">(</span><span class="n">PoolAction</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pool</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;IORAcquisition&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_channels</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">PoolAction</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pool</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">start_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">in_acquisition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">states</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>
        <span class="k">pass</span>

    <span class="nd">@DebugIt</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">action_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">states</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channels</span><span class="p">:</span>
            <span class="n">states</span><span class="p">[</span><span class="n">element</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">values</span><span class="p">[</span><span class="n">element</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># read values to send a first event when starting to acquire</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="n">ret</span><span class="o">=</span><span class="n">values</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">acquirable</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">acquirable</span><span class="o">.</span><span class="n">put_value</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">propagate</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_state_info</span><span class="p">(</span><span class="n">ret</span><span class="o">=</span><span class="n">states</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_acquisition</span><span class="p">(</span><span class="n">states</span><span class="p">):</span>
                <span class="k">break</span>

            <span class="c1"># read value every n times</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">5</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="n">ret</span><span class="o">=</span><span class="n">values</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">acquirable</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">acquirable</span><span class="o">.</span><span class="n">put_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">read_state_info</span><span class="p">(</span><span class="n">ret</span><span class="o">=</span><span class="n">states</span><span class="p">)</span>

        <span class="c1"># first update the element state so that value calculation</span>
        <span class="c1"># that is done after takes the updated state into account</span>
        <span class="k">for</span> <span class="n">acquirable</span><span class="p">,</span> <span class="n">state_info</span> <span class="ow">in</span> <span class="n">states</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">acquirable</span><span class="o">.</span><span class="n">set_state_info</span><span class="p">(</span><span class="n">state_info</span><span class="p">,</span> <span class="n">propagate</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Do NOT send events before we exit the OperationContext, otherwise</span>
        <span class="c1"># we may be asked to start another action before we leave the context</span>
        <span class="c1"># of the current action. Instead, send the events in the finish hook</span>
        <span class="c1"># which is executed outside the OperationContext</span>

        <span class="k">def</span> <span class="nf">finish_hook</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="c1"># read values and propagate the change to all listeners</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="n">ret</span><span class="o">=</span><span class="n">values</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">acquirable</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">acquirable</span><span class="o">.</span><span class="n">put_value</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">propagate</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

            <span class="c1"># finally set the state and propagate to all listeners</span>
            <span class="k">for</span> <span class="n">acquirable</span><span class="p">,</span> <span class="n">state_info</span> <span class="ow">in</span> <span class="n">states</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">acquirable</span><span class="o">.</span><span class="n">set_state_info</span><span class="p">(</span><span class="n">state_info</span><span class="p">,</span> <span class="n">propagate</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_finish_hook</span><span class="p">(</span><span class="n">finish_hook</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright Except where otherwise noted, content on this site is
licensed under a Creative Commons Attribution 3.0 License.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'2.5.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>